<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>ë³‘ì› ì•ˆë‚´ í‚¤ì˜¤ìŠ¤í¬</title>
  <link rel="icon" href="/favicon.ico" type="image/x-icon">
  <style>
    #status.loading::after {
      content: ' â³';
      animation: blink 1s infinite;
    }
    @keyframes blink {
      50% { opacity: 0.3; }
    }
    .hidden {
      display: none;
    }
    .large-button {
      font-size: 20px;
      padding: 12px 24px;
      margin: 10px;
      display: inline-block;
      background-color: #e0e0e0;
      border-radius: 5px;
    }
  </style>
</head>
<body>
  <h2>ë³‘ì› ì•ˆë‚´ í‚¤ì˜¤ìŠ¤í¬</h2>

  <!-- ì´ˆê¸° ì‹œì‘ ë²„íŠ¼ -->
  <div id="startSection">
    <button class="large-button" onclick="startKiosk()">ì‹œì‘</button>
  </div>

  <!-- ì•ˆë‚´ ë©”ì‹œì§€ ë° í…ìŠ¤íŠ¸ í•­ëª© -->
  <div id="mainSection" class="hidden">
    <!-- í•­ìƒ í˜„ì¬ TTS í…ìŠ¤íŠ¸ê°€ í‘œì‹œë  ì˜ì—­ -->
    <p id="ttsDisplayText" style="font-weight: bold; font-size: 18px; margin-top: 20px;">
      ë³‘ì› ì•ˆë‚´ í‚¤ì˜¤ìŠ¤í¬ì…ë‹ˆë‹¤. ì—…ë¬´ëŠ” ì ‘ìˆ˜, ì ‘ìˆ˜ë‚´ì—­ í™•ì¸, ê¸¸ì°¾ê¸°ê°€ ìˆìŠµë‹ˆë‹¤. ì›í•˜ì‹œëŠ” ì—…ë¬´ë¥¼ ë§ì”€í•´ì£¼ì„¸ìš”.
    </p>

    <div>
      <ul style="font-size: 20px; line-height: 2;">
        <li>ì ‘ìˆ˜</li>
        <li>ì ‘ìˆ˜ ë‚´ì—­ í™•ì¸</li>
        <li>ê¸¸ì°¾ê¸°</li>
      </ul>
    </div>

    <!-- ìŒì„± ì…ë ¥ ë° ì—…ë¡œë“œ -->
    <h3>ìŒì„± ì…ë ¥</h3>
    <input type="file" id="audioFile" accept="audio/wav" />
    <button id="uploadBtn" onclick="uploadAudio()">ì—…ë¡œë“œ</button>

    <h3>ê²°ê³¼</h3>
    <p id="status">ìƒíƒœ: ëŒ€ê¸° ì¤‘</p>
    <p><strong>STT:</strong> <span id="sttText"></span></p>
    <p><strong>LLM:</strong> <span id="llmText"></span></p>
    <p><strong>TTS:</strong> <span id="ttsText"></span></p>

    <!-- ìˆ¨ê²¨ì§„ ì˜¤ë””ì˜¤ -->
    <audio id="ttsAudio" style="display:none;"></audio>
  </div>

  <!-- ì„œë²„ ìƒíƒœ -->
  <h3>ì„œë²„ ìƒíƒœ</h3>
  <ul id="healthStatus">
    <li>STT: <span id="sttStatus">â³</span></li>
    <li>LLM: <span id="llmStatus">â³</span></li>
    <li>TTS: <span id="ttsStatus">â³</span></li>
  </ul>

  <script>
    function startKiosk() {
      document.getElementById("startSection").classList.add("hidden");
      document.getElementById("mainSection").classList.remove("hidden");

      const text = "ë³‘ì› ì•ˆë‚´ í‚¤ì˜¤ìŠ¤í¬ì…ë‹ˆë‹¤. ì—…ë¬´ëŠ” ì ‘ìˆ˜, ì ‘ìˆ˜ë‚´ì—­ í™•ì¸, ê¸¸ì°¾ê¸°ê°€ ìˆìŠµë‹ˆë‹¤. ì›í•˜ì‹œëŠ” ì—…ë¬´ë¥¼ ì„ íƒí•˜ê±°ë‚˜ ë§ì”€í•´ì£¼ì„¸ìš”.";
      document.getElementById("ttsDisplayText").innerText = text;

      fetch("/speak", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ text }),
      })
      .then(res => res.json())
      .then(data => {
        if (data.audio_path) {
          const audio = document.getElementById("ttsAudio");
          document.getElementById("ttsText").innerText = "ğŸ”Š ìŒì„± ì•ˆë‚´ ì¤‘...";
          audio.src = `/ttsaudio/${data.audio_path}`;
          audio.load();
          audio.play();
          audio.onended = () => {
            document.getElementById("ttsText").innerText = "âœ… ìŒì„± ì•ˆë‚´ ì™„ë£Œ";
          };
        }
      });
    }

    async function checkHealth() {
      try {
        const response = await fetch("/health");
        const data = await response.json();
        document.getElementById("sttStatus").innerText = data.stt ? "[v] OK" : "[x] Down";
        document.getElementById("llmStatus").innerText = data.llm ? "[v] OK" : "[x] Down";
        document.getElementById("ttsStatus").innerText = data.tts ? "[v] OK" : "[x] Down";
      } catch (err) {
        ["sttStatus", "llmStatus", "ttsStatus"].forEach(id => {
          document.getElementById(id).innerText = "[x] Error";
        });
      }
    }

    async function uploadAudio() {
      const fileInput = document.getElementById('audioFile');
      const file = fileInput.files[0];
      const uploadBtn = document.getElementById("uploadBtn");
      const status = document.getElementById("status");
      const ttsText = document.getElementById("ttsText");
      const ttsDisplayText = document.getElementById("ttsDisplayText");

      if (!file) return alert("íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”");

      uploadBtn.disabled = true;
      status.innerText = "ìƒíƒœ: ì—…ë¡œë“œ ì¤‘...";
      status.classList.add("loading");

      try {
        const formData = new FormData();
        formData.append("file", file);

        const response = await fetch("/upload-audio/", {
          method: "POST",
          body: formData,
        });
        const data = await response.json();
        const file_id = data.file_id;

        const ws = new WebSocket(`ws://${location.host}/ws/kiosk`);
        ws.onmessage = (event) => {
          const msg = JSON.parse(event.data);

          if (msg.stage === "status") {
            status.innerText = "ìƒíƒœ: " + msg.text;
          } else if (msg.stage === "stt") {
            document.getElementById("sttText").innerText = msg.text;
          } else if (msg.stage === "llm") {
            document.getElementById("llmText").innerText = msg.text;
          } else if (msg.stage === "tts") {
            const audio = document.getElementById("ttsAudio");
            ttsText.innerText = "ğŸ”Š ìŒì„± ì•ˆë‚´ ì¤‘...";
            ttsDisplayText.innerText = msg.text;
            audio.src = msg.audio_url;
            audio.load();
            audio.play();
            audio.onended = () => {
              ttsText.innerText = "";
            };
            uploadBtn.disabled = false;
            fileInput.value = "";
          }
        };

        ws.onopen = () => {
          status.innerText = "ì²˜ë¦¬ ì‹œì‘...";
          ws.send(JSON.stringify({ file_id }));
        };

        ws.onerror = () => {
          status.innerText = "WebSocket ì—°ê²° ì‹¤íŒ¨";
          status.classList.remove("loading");
        };

        ws.onclose = () => {
          uploadBtn.disabled = false;
          status.classList.remove("loading");
        };
      } catch (err) {
        console.error(err);
        status.innerText = "[x] ì˜¤ë¥˜ ë°œìƒ: " + err.message;
        status.classList.remove("loading");
        uploadBtn.disabled = false;
      }
    }

    window.onload = () => {
      checkHealth();
      setInterval(checkHealth, 10000);
    };
  </script>
</body>
</html>
